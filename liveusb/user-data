#cloud-config
autoinstall:
  version: 1
  update: yes
  storage:
    layout:
      name: direct
  identity:
    hostname: contest-sdr
    password: "$6$.vRK/TtPfFXVCfAl$a/AIho/TLHbnTcG5ZNUWZlx4tbEKzeL/O05GVr3TfWJ7xvllTzYfbPzvzuB04eLM.KN6Rw22yW5ezqLx/oWvm1" # contest
    username: contest
  packages:
    - xubuntu-core
    - gnuradio
    - gqrx-sdr
    - uhd-host
    - libsoapysdr-dev
    - libiio-dev
    - libad9361-dev
    - cmake
  late-commands:
    - curtin in-target --target=/target -- apt-get -y purge gdm3
    - echo [SeatDefaults] >> /target/etc/lightdm/lightdm.conf.d/login.conf
    - echo user-session=xubuntu >> /target/etc/lightdm/lightdm.conf.d/login.conf
    - echo autologin-user=contest >> /target/etc/lightdm/lightdm.conf.d/login.conf
    - git clone https://github.com/argilo/contest-sdr.git /target/opt/contest-sdr
    - mkdir -p /target/etc/skel/Desktop
    - cp /target/opt/contest-sdr/liveusb/contest-sdr.desktop /target/etc/skel/Desktop/
    - chmod u+x /target/etc/skel/Desktop/contest-sdr.desktop
    - mkdir -p /target/etc/skel/.local/share/applications
    - cp /target/opt/contest-sdr/liveusb/contest-sdr.desktop /target/etc/skel/.local/share/applications/
    - curtin in-target --target=/target -- /usr/bin/uhd_images_downloader
    - cp /target/opt/contest-sdr/liveusb/udev/*.rules /etc/udev/rules.d/
    - git clone https://github.com/pothosware/SoapyPlutoSDR.git /target/opt/SoapyPlutoSDR
    - mkdir /target/opt/SoapyPlutoSDR/build
    - curtin in-target --target=/target -- cmake -DCMAKE_INSTALL_PREFIX=/usr -S /opt/SoapyPlutoSDR -B /opt/SoapyPlutoSDR/build
    - curtin in-target --target=/target -- cmake --build /opt/SoapyPlutoSDR/build
    - curtin in-target --target=/target -- cmake --install /opt/SoapyPlutoSDR/build
